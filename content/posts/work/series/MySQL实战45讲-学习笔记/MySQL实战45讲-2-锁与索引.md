---
title: "MySQL实战45讲(2)-锁与索引"
date: 2021-04-01T17:45:11+08:00
description: ""
tags: ["MySQL", "网课笔记"]
categories: "MySQL实战45讲"
draft: true


---

> 系列文章源自极客时间[《MySQL实战45讲》](http://gk.link/a/10pWf)课程的学习整理。

## 简介

索引和锁是MySQL中最重要的概念之一，在介绍他们的具体原理和使用规则之前，我们不妨回到数据库的本质——文件，来考虑一个抽象的数据库。

所谓数据，即按照一定格式编排的文件，他们被保存在数据库中，就好象书本被存放在一个图书馆中（虽然这个例子很烂大街，原理更重要，当然也希望大家能够看完这个例子，接下来的叙述都会围绕这个图书馆数据库展开）。我们对数据的增删改查，本质就相当于在这个图书馆中添加/移除/修改/查找书本。

> 行式数据库 vs. 列式数据库
>
>  这里将一行数据跟一本书做比，我们假设对一本书的操作都是不可分割的，即不能对一本书的不同页（即多个字段）同时做修改。这种限制在MySQL中体现为，修改数据的最小单位就是一行，多个字段的修改只能完成后，一并写回文件。
> 当然这种限制不是必须的，MySQL有这样的限制是因为它的数据在磁盘中是以行为单位紧密排列的，读取数据入内存的时候只能读完整的一行（实际上按页读取若干完整行），在内存中完成修改之后再按行完整写回磁盘。列式数据库则把单行数据按列保存在分散的地方，可以按列读取，就没有这种限制。 

要想从图书馆中找书，我们大可以一本一本去找（全表扫描），但效率很显然是非常低的。怎样提高找书的效率？这就自然地引入了索引概念，先看看

1. 整理一本目录，记下每本书所在的位置。找书的时候先找目录，再去对应位置取书。
2. 把图书馆按照楼层、区域、书架编号。找书的时候按照书的编号，先找到楼层，再找区域、书架位置找到书。

对应到MySQL的索引，就是：

1. 非聚簇索引。把索引（目录）和数据（书）分开文件存放，先找从索引文件找到目标所在的位置，再去数据文件取数据。 
2. 聚簇索引。直接把索引（楼层/区域/书架编号）和数据（书）放在同一个文件。查找的时候直接在文件中寻找目标，找到了索引，也就找到了数据。

Innodb的主键使用的就是聚簇索引，其他字段上的索引则是非聚簇索引，也称二级索引。MyISAM则不论主键和普通字段均使用非聚簇索引。而这两种索引对查询的影响是，非聚簇索引需要两次读文件（称为**回表**）才能够取得目标数据；聚簇索引则只需要读一次文件。因此主键是非常重要的资源，能使用主键时尽量使用主键。

那么有没有什么方法可以即不查主键，不需要回表查询呢？也有，那就是覆盖索引。

索引如果是多个字段怎么版？最左原则。

索引下推。



将这就自然地引入了索引的概念。在具体介绍各种索引类型之前，先来想想**索引的本质是什么？当我们说给某个字段加索引的时候，物理上做了什么事情？**

还是图书馆的例子，为了让



在最常用的Innodb引擎，索引类型有两种：Hash索引 和 B+Tree索引。他们的差异源自于结构：

- Hash索引的底层是HashMap，B+Tree底层是B+树
- Hash索引对等值查询

在明确了对一行数据的修改后，两个人先后（A先B后）从图书馆拿走了一本书的拷贝回去做修改。A删除了儿童不宜的内容后把这本健康的书还给图书馆（写回磁盘）替换旧书（修改数据），稍后B又未删除相关内容就把书还给图书馆替换已经修改的健康书，导致这本书又变得儿童不宜。因此